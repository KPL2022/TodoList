<!DOCTYPE html>

<html>
  <head>
    <title>KPL Todo List</title>
  </head>
  <body>

    <button id="toggleall-button">Toggle all todos</button>

    <!-- button based add -->
    <button id="add-button">Add a todo</button>

    <input id="add-input" placeholder="new todo text">

    <!-- main todo list container -->
    <ul id="todo-list">
    </ul>

    <!-- js related -->
    <script>

      /**
       * basic display setup work, hooking up buttons, also functions that
       * operate on multiple todo entries go here
      */

      // button based toggleAll
      var togAllBtn = document.getElementById('toggleall-button');

      togAllBtn.addEventListener('click', toggleAll);

      // button based add
      var addBtn = document.getElementById('add-button');

      var addInput = document.getElementById('add-input');

      addBtn.addEventListener('click', add);

      /**
       * toggles all todo entries with rules:
       * 
       * 1. none or some entries checked -> make all entries checked
       * 2. if all entries checked -> uncheck all entries
       * 
       * o(n) 2-pass b/c status depends on col based property, need 1-pass first
      */
      function toggleAll() {

        var priorStatus = true;

        todos.forEach(todoEntry => {

          priorStatus = priorStatus && todoEntry.completed;
        });

        batchSetCompletionStatus(!priorStatus);
      }

      // set completion status of entire container with status given
      function batchSetCompletionStatus(status) {

        todos.forEach(todoEntry => {
          todoEntry.completed = status;
          todoEntry.disp.children[0].innerText = getStatusStr(status);
        });
      }
      
      /**
       * setting up todo entry obj container, and handlers that respond to user actions
      */

      // obj reference access scheme, no order constraint, set contains all todo entry objs
      var todos = new Set();

      // 2-layer wrapper to provide event handler with obj ref of todo entry to work on,
      // and addr of action to take
      function contxtAction(entryRef) {
        
        var lstEntry = entryRef;

        function actionWrapper(action) {

          function applyContxtToAction() {

            action(lstEntry);
          }

          return applyContxtToAction;
        }

        return actionWrapper;
      }

      // remove the given todo entry both from container and display
      function rmv(lstEntry) {

        todos.delete(lstEntry);

        // remove related disp
        var todoList = document.getElementById('todo-list');
        todoList.removeChild(lstEntry.disp);
      }

      // setting up display to receive user edit contents
      function editRequest(lstEntry) {

        // access edit input field and set current todoText as starting text
        lstEntry.disp.children[1].value = lstEntry.todoText;
        
        // remove original text from display
        var linTxt = lstEntry.disp.childNodes[1];
        linTxt.textContent = '';

        // switch disp between edit button & edi field + confirm button
        lstEntry.disp.children[3].style.display = 'none';
        lstEntry.disp.children[1].style.display = '';
        lstEntry.disp.children[2].style.display = '';
      }

      // reflecting user changes to container and display
      function editConfirm(lstEntry) {

        // get replacement txt from input field
        var dIn = lstEntry.disp.children[1];
        var replacement = dIn.value;

        // update todo text and renew displayed data
        lstEntry.todoText = replacement;
        lstEntry.disp.childNodes[1].textContent = replacement;
        dIn.style.display = 'none';
        lstEntry.disp.children[2].style.display = 'none';

        lstEntry.disp.children[3].style.display = '';
      }

      // toggle the given todo entry
      function toggle(lstEntry) {

        lstEntry.completed = !lstEntry.completed;

        // update disp
        var togBtn = lstEntry.disp.children[0];
        togBtn.innerText = getStatusStr(lstEntry.completed);
      }

      /**
       * creating todo entry objs here, and implant needed info for handlers to respond to
       * user actions with closure
      */

      // add new todo entry
      function add() {
        
        // get user text and create todo entry
        var lstEntry = createTodoEntry(addInput.value);
        
        // clean up input field
        addInput.value = "";

        // update container
        todos.add(lstEntry);

        // update display
        var todoList = document.getElementById('todo-list');
        todoList.appendChild(lstEntry.disp);
      }

      // create todo entry obj, and set up event handlers to handle user actions
      function createTodoEntry(newItemText) {

        var lstEntry = { todoText: newItemText, 
                         completed: false,
                         disp: document.createElement("li")};

        var perform = contxtAction(lstEntry);

        // add toggle button to disp
        lstEntry.disp.appendChild(createButton(getStatusStr(lstEntry.completed), perform(toggle), false));
        
        // create text node and input field for edits
        lstEntry.disp.appendChild(document.createTextNode(lstEntry.todoText));
        lstEntry.disp.appendChild(createInputField(true));

        // add edit confirm button to disp
        lstEntry.disp.appendChild(createButton('confirm', perform(editConfirm), true));

        // add edit request button to disp
        lstEntry.disp.appendChild(createButton('edit', perform(editRequest), false));
        
        // add remove button to disp
        lstEntry.disp.appendChild(createButton('remove', perform(rmv), false));

         return lstEntry; 
      }

      function createButton(txt, handlerFx, hide) {

        var btn = document.createElement('button');
        btn.innerText = txt;
        btn.addEventListener('click', handlerFx);

        if (hide) {

          btn.style.display = 'none';
        }

        return btn;
      }

      function createInputField(hide) {
    
        // start by generating an edit platform with unique id
        var dIn = document.createElement('input');

        if (hide) {
          dIn.style.display = 'none';
        }

        return dIn;
      }

      function getStatusStr(status) {

        if (status) {

          return "[v^]";
        } else {

          return "[ ]";
        }
      }
    </script>
  </body>

</html>